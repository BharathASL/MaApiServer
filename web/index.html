<html>
    <head>
        <title>Service Checker UI</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="development_only/bootstrap.css" rel="stylesheet" type="text/css"/>
        <link href="development_only/bootstrap-toggle.min.css" rel="stylesheet" type="text/css"/>
        <link href="development_only/datatables.min.css" rel="stylesheet" type="text/css"/>
        <script src="development_only/jquery.js" type="text/javascript"></script>
        <script src="development_only/bootstrap.js" type="text/javascript"></script>
        <script src="development_only/bootstrap-toggle.min.js" type="text/javascript"></script>
        <script src="development_only/datatables.min.js" type="text/javascript"></script>
        <script src="development_only/websqldump.js" type="text/javascript"></script>
        <style>
            body{
                margin-bottom: .5rem;
                font-family: inherit;
                font-weight: 500;
                line-height: 1.2;
                color: white;
                font-size: 2.5em;
                padding-top: 20px;
                background-color: #222;
            }
            .default-background-color{
                background-color: #222 !important;
                color: white;
            }
            .float-right{
                float: right;
            }
            .inline{
                display: inline-block;
            }
            .eachRow{}
            .spinner{
                /*position: absolute;*/
                top: 50%;
                left: 50%;
                position:fixed;
                width:100%;
                left:0;right:0;top:0;bottom:0;
                background-color: rgba(255,255,255,0.7);
                z-index:9999;
                display:none;
            }
            @-webkit-keyframes spin {
                from {-webkit-transform:rotate(0deg);}
                to {-webkit-transform:rotate(360deg);}
            }
            @keyframes spin {
                from {transform:rotate(0deg);}
                to {transform:rotate(360deg);}
            }
            .spinner::after {
                content:'';
                display:block;
                position:absolute;
                left:48%;top:40%;
                width:40px;height:40px;
                border-style:solid;
                border-color:black;
                border-top-color:transparent;
                border-width: 4px;
                border-radius:50%;
                -webkit-animation: spin .8s linear infinite;
                animation: spin .8s linear infinite;
            }
            ::-webkit-input-placeholder {
                text-align: center;
            }
            :-moz-placeholder { /* Firefox 18- */
                text-align: center;  
            }
            ::-moz-placeholder {  /* Firefox 19+ */
                text-align: center;  
            }
            :-ms-input-placeholder {  
                text-align: center; 
            }
            pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
            .string { color: green; }
            .number { color: darkorange; }
            .boolean { color: blue; }
            .null { color: magenta; }
            .key { color: red; }
        </style>
    </head>
    <body>
        <div class="container" style="margin-top: 100px;" id="body">
            <div class="row form-group">
                <div class="col-lg-12">
                    <!--<strong>URL :-</strong>--> 
                    <span id="urlText" style="display: inline-block;"></span>
                </div>
            </div>
            <div class="row form-group" style="padding-bottom: 50px">
                <!--                <div class="col-lg-3">
                                </div>-->
                <div class="col-lg-5">
                    <input type="text" id="servletName" class="form-control"/>
                </div>
                <div class="col-lg-7">
                    <input type="button" id="btnClearAll" class="btn btn-danger" value="Clear All"/>
                    <input type="button" class="btn btn-primary" value="SQL" onclick='$("#webSQLModel").modal("show")'/>
                    <input type="button" class="btn btn-primary" id="historyShowBtn" value="History"/>
                    <input type="button" class="btn btn-primary" id="btnStatus" value="Status" style="visibility: hidden"/>
                    <input id="requestMethod" class="toogle-active-plan method-type" type="checkbox" checked data-toggle="toggle" data-on="POST" data-off="GET">
                    <input id="autoRequest" class="toogle-active-plan" type="checkbox" checked data-toggle="toggle" data-on="Auto Req. Off" data-off="Auto Req. ON">
                    <input type="button" class="btn btn-primary" id="btnDoRequest" value="Request"/>
                </div>
            </div>
            <div class="row form-group">
                <div class="col-lg-2">
                </div>
                <div class="col-lg-2">
                    <!--                    <select id="typeData" class="form-control">
                                            <option class="form-control" value="select">General</option>
                                            <option class="form-control" value="data">Extra Data</option>
                                        </select>-->
                </div>
                <div class="col-lg-8 float-right">
                    <input type="button" class="btn btn-success" id="copyAjaxCode" value="Copy JQ.Ajax Code"/>
                    <input type="button" class="btn btn-warning" id="btnClearParam" value="Clear Params"/>
                    <input type="button" class="btn btn-danger" id="btnClearResponse" value="Clear Response"/>
                    <input type="button" class="btn btn-primary" id="btnAddParam" value="Add Param"/>
                    <input type="button" class="btn btn-success" id="btnInputAsJSON" value="Input As JSON"/>
                    <input id="gapiRequest" class="toogle-active-plan" type="checkbox" checked data-toggle="toggle" data-on="Generic" data-off="GApi">
                </div>
            </div>
            <div id="paramDiv" class="form-group">
                <div class="row eachRow form-group">
                    <div class="col-lg-11 row">
                        <div class="col-lg-2">
                            name
                        </div>
                        <div class="col-lg-4">
                            <input type="text" class="col-lg-12 form-control name-list"/>
                        </div>
                        <div class="col-lg-2">
                            value
                        </div>
                        <div class="col-lg-4">
                            <input type="text" class="col-lg-12 form-control value-list"/>
                        </div>
                    </div>
                    <div class="col-lg-1 row">
                        <input type="button" class="btn btn-warning col-lg-12" value="X" onclick="$(this).parent().parent().remove();"/>
                    </div>
                    <!--                    <div class="col-lg-1">
                                            <input type="button" class="btn btn-warning btn-remove-param" value="-"/>
                                        </div>-->
                </div>
            </div>
            <!--            <div class="form-group">
                            <div class="row">
                                <div class="col-lg-10">
                                </div>
                                <div class="col-lg-1">
                                    <input type="button" class="btn btn-danger float-right" id="btnAddExtraDataParam" value="Add Param"/>
                                </div>
                                <div class="col-lg-1">
                                    <input type="button" class="btn btn-danger float-right" id="btnAddExtraDataCount" value="Add Data"/>
                                </div>
                            </div><br>
                            <div class="row eachRowExtraData form-group">
                                <div id="ex-dat-head-row">
                                    <div class="ex-dat-head-cel">
                                        <input type="text" class="col-lg-12 form-control headExtraData"/>
                                    </div>
                                </div>
                            </div>
                        </div>
            -->            
            <div id="gapiJSONContainer" class="form-group" style="display:none">
                <label for="response">JSON</label>
                <textarea class="form-control" rows="5" id="gapiJSON"></textarea>
            </div>
            <div class="form-group">
                <label for="response">Response</label>
                <textarea class="form-control" rows="5" id="response"></textarea>
            </div>
            <div class="form-group row">
                <input type="button" class="btn btn-link float-right" id="btnResponseInNewWindow" value="Response in New Window"/>
            </div>
            <div class="form-group row">
                <div id="errorHtml">
                </div>
            </div>
            <!-- Modal -->
            <div class="modal fade" id="errorModal" role="dialog">
                <div class="modal-dialog">
                    <!-- Modal content-->
                    <div class="modal-content">
                        <div class="modal-body default-background-color">
                            <div class="form-group container row">
                                <label>Response code</label>: <span id="lastResponseCode"></span><br>
                                <label>Request Sent On</label>: <span id="lastResponseStart"></span><br>
                                <label>Response Received On</label>: <span id="lastResponseEnd"></span><br>
                                <label>Time taken</label>: <span id="timeCost">ms</span><br>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div id="historyModal" class="modal fade" role="dialog">
            <div class="modal-dialog modal-lg" style="margin-left: 15%;width: 70%;">
                <div class="modal-content" style="color:black">
                    <div class="modal-body" style="zoom: 0.65;overflow: scroll;">
                        <table id="historyDatatable" class="table table-dark table-striped table-hover" style="color: black;width: 100% !important;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Sub URL</th>
                                    <th>Method</th>
                                    <th style="width: 50% !important">Parameters</th>
                                    <th>Response</th>
                                    <th>Status Code</th>
                                    <th>Request Time</th>
                                    <th>Generic/Gapi</th>
                                    <th>Load to form</th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    <th>ID</th>
                                    <th>Sub URL</th>
                                    <th>Method</th>
                                    <th>Parameters</th>
                                    <th>Response</th>
                                    <th>Status Code</th>
                                    <th>Request Time</th>
                                    <th>Generic</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal -->
        <div id="webSQLModel" class="modal fade" role="dialog">
            <div class="modal-dialog modal-lg" style="margin-left: 25%;width: 50%;">
                <div class="modal-content" style="color:black">
                    <div class="modal-body">
                        <div class="row">
                            <style>
                                .h-100px{height: 100px;}
                            </style>
                            <div class="col-lg-12">
                                <div style="margin: auto;width: fit-content;">
                                    <input id="dumpWebSqlToHost" type="button" class="btn btn-warning h-100px" value="Backup WebSQL Dump to HOST"/>
                                    <input id="dropDatabase" type="button" class="btn btn-danger h-100px" value="Truncate"/>
                                    <input id="showHostDumpFiles" type="button" class="btn btn-primary h-100px"  value="Show Dump Files"/>
                                </div>
                                <!--<input type="button" class="btn btn-success" id="btnInputAsJSON" value="Input As JSON"/>-->
                            </div>
                            <!-- loading spinner -->
                            <div id="sqlSpinner" class="spinner"></div>
                            <div style="display:none;margin: 40px;">
                                <table id="dumpFileList" class="table table-dark table-striped table-hover" style="color: black;">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Size(Bytes)</th>
                                            <th>Time</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <span id="pageAge" style="position: fixed;top:0;right:0;padding: 10px"></span>
        <span id="connectionStatus" style="position: fixed;bottom: 0;right:0;padding: 10px;">
            <span style="color: gray;">
                Connection Status
                <input id="showConnectionSwitch" class="toogle-active-plan" type="checkbox" checked data-toggle="toggle" data-on="On" data-off="Off">
            </span>
            <span class="connected" style="color: gray; display: none;">Connected</span>
            <span class="disconnected" style="color: red; display: none;">Disconnected</span>
        </span>
        <!-- loading spinner -->
        <div id="loader" class="spinner"></div>
        <input type="text" value="Hello World" id="copyTextHolder" style="opacity: 0;">
        <script>
            var db; //Database connection
            var statusConnectionInterval;
            document.onkeyup = function (e) {
                if (e.ctrlKey && e.keyCode == 13)
                    if (e.shiftKey)
                        $("#btnResponseInNewWindow").click();
                    else
                        $("#btnDoRequest").click();
                else if (e.keyCode == 27) {
                    if ($("#autoRequest").parent().attr("class").includes("off")) {
                        $($("#autoRequest").parent()[0]).click();
                    }
                }
            };
            var t1 = new Date();
            $(document).ready(function () {
                if (localStorage.showConnection == undefined) {
                    localStorage.showConnection = true;
                } else if (localStorage.showConnection == false) {
                    $($("#showConnectionSwitch").parent()[0]).click();
                }
                $('.method-type').bootstrapToggle({
                    on: 'POST',
                    off: 'GET'
                });
                $('#showConnectionSwitch').bootstrapToggle({
                    on: 'Show Connection Status',
                    off: 'Hide Connection Status'
                }).change(function () {
                    if ($("#showConnectionSwitch").parent().attr("class").includes("off")) {
                        try {
                            clearInterval(statusConnectionInterval);
                        } catch (e) {
                        }
                    } else {
                        statusConnectionInterval = window.setInterval(function () {
                            $.ajax({
                                url: "./development_only/sort_desc.png",
                                complete: function (xhr, textStatus) {
                                    if (xhr.status == 200) {
                                        $("#connectionStatus").find(".disconnected").hide();
                                        $("#connectionStatus").find(".connected").show();
                                    } else {
                                        $("#connectionStatus").find(".disconnected").show();
                                        $("#connectionStatus").find(".connected").hide();
                                    }
                                }
                            });
                        }, 1000);
                    }
                });
                $('#gapiRequest').bootstrapToggle({
                    on: 'Generic',
                    off: 'GApi'
                });
                $('#autoRequest').bootstrapToggle({
                    on: 'Auto Request Off',
                    off: 'Auto Request On'
                });
                db = openDatabase('ServiceCheckerUI', '1.0', 'Checker UI DB DB', 2 * 1024 * 1024); //Creating Connection
                db.transaction(function (tx) {
                    tx.executeSql('CREATE TABLE IF NOT EXISTS history (ID  INTEGER PRIMARY KEY, SUB_URL, METHOD, PARAMETERS, RESPONSE, STATUS_CODE , REQUEST_TIME DEFAULT CURRENT_TIMESTAMP)');
                });
                if (localStorage.servletName != undefined && localStorage.data != undefined && localStorage.requestMethod != undefined) {
                    $("#servletName").val(localStorage.servletName);
                    if (localStorage.requestMethod == "GET") {
                        $($("#requestMethod").parent()[0]).click();
                    }
                    var data = JSON.parse(localStorage.data);
                    if (localStorage.data.charAt(0) == "[") {
                        for (var i = 0; i < data.length; i++) {
                            $("#paramDiv").append($('.eachRow').wrap('<div/>').parent().html());
                            $($(".name-list")[i]).val(data[i].name);
                            $($(".value-list")[i]).val(data[i].value);
                        }
                        disableLastEachRow();
                    } else if (localStorage.data.charAt(1) == "{") {
                        $($("#gapiRequest").parent()[0]).click();
                        try {
                            $("#gapiJSON").val(JSON.parse(localStorage.data));
                        } catch (e) {
                            alert("Invalid JSON data in history for Gapi request; " + e.toString());
                        }
                    }
                }
                $("#loader").hide();
                disableLastEachRow();
                //                $.ajaxStart(function () {
                //                });
                //                $.ajaxComplete(function (xhr, textStatus) {
                //                });
                var href = location.href.split("/");
                href.pop();
                $("#urlText").html(href.join("/") + "/");
                t1 = new Date();
                setInterval(function () {
                    var t2 = new Date();
                    var dif = t1.getTime() - t2.getTime();
                    var Seconds_from_T1_to_T2 = dif / 1000;
                    var Seconds_Between_Dates = Math.abs(Seconds_from_T1_to_T2);
                    var date = new Date(null);
                    date.setSeconds(Seconds_Between_Dates); // specify value for SECONDS here
                    var result = date.toISOString().substr(11, 8);
                    $("#pageAge").html(result);
                }, 1000);
                if (localStorage.showConnection == "true") {
                }
            });
            $("#btnInputAsJSON").click(function () {
                if (localStorage.data != undefined) {
                    var data = {};
                    var localArray = JSON.parse(localStorage.data);
                    for (var i = 0; i < localArray.length; i++) {
                        data[localArray[i].name] = localArray[i].value;
                    }

                    var response;
                    try {
//                        response = "<pre>" + JSON.stringify(data, null, 4) + "</pre>";
                        response = "<pre>" + coloredJSONStringify(JSON.stringify(data, null, 4)) + "</pre>";
//                        response = "<pre>" + syntaxHighlight(JSON.stringify(JSON.parse($("#response").val()), null, 4)) + "</pre>";
//                        response = coloredJSONStringify(data);
                    } catch (e) {
                        console.log("Error converting response string to JSON; Error code " + e);
                        response = JSON.stringify(data);
                    }
                    //                    if (response.trim(" ") == "") {
                    //                        alert("Empty input");
                    //                    } else {
                    var win = window.open("", "Error", "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=" + screen.availWidth + ",height=" + screen.availHeight);
                    win.document.body.innerHTML = response;
                    //                    }
                }
            });
            $("#btnDoRequest").click(function () {
                var servletName = $("#servletName").val().trim(" ");
                if (servletName != "") {
                    var data = {};
                    var paramsWithValue = [];
                    var complete = false;
                    if ($("#gapiRequest").parent().attr("class").includes("off")) {
                        try {
                            data = JSON.stringify(JSON.parse($("#gapiJSON").val()));
                            complete = true;
                        } catch (e) {
                            complete = false;
                            console.log("Invalid JSON data for GApi Request; " + e.toString());
                        }
                    } else if ($(".eachRow").length > 1) {
                        for (var i = 0; i < $(".eachRow").length - 1; i++) {
                            if ($($(".name-list")[i]).val() != ""
//                                    && $($(".value-list")[i]).val() != ""
                                    ) {
                                try {
                                    var json = JSON.parse($($(".value-list")[i]).val());
                                    data[$($(".name-list")[i]).val()] = JSON.stringify(json);
                                } catch (e) {
                                    data[$($(".name-list")[i]).val()] = $($(".value-list")[i]).val();
                                }
                                paramsWithValue.push({name: $($(".name-list")[i]).val(), value: $($(".value-list")[i]).val()});
                                if ($(".eachRow").length - 2 == i) {
                                    complete = true;
                                    break;
                                }
                            } else {
                                break;
                            }
                        }
                    } else {
                        complete = true;
                    }
                    if (complete) {
//                        localStorage.clear();
                        localStorage.servletName = servletName;
                        localStorage.data = JSON.stringify($("#gapiRequest").parent().attr("class").includes("off") ? data : paramsWithValue);
                        localStorage.requestMethod = $("#requestMethod").prop("checked") ? "POST" : "GET";
                        $("#loader").show();
                        $("#errorHtml").html();
                        $("#response").val();
                        var requestMethod = $("#requestMethod").prop("checked") ? "POST" : "GET";
//                        try {
//                            requestMethod = localStorage.getItem("requestMethod") != null ? localStorage.requestMethod : "POST";
//                        } catch (e) {
//                        }
                        var ajaxcallData = {
                            type: requestMethod,
                            url: "./" + servletName,
                            dataType: 'json',
//                            contentType: 'application/json; charset=utf-8',
//                            contentType: 'application/json; charset=utf-8',
//                            mimeType: 'application/json',
                            success: function (response, textStatus, xhr) {
                                t1 = new Date();
                                $("#loader").hide();
                                try {
                                    response = (JSON.stringify(response));
                                } catch (e) {
                                }
                                $("#response").val(response);
                                $("#lastResponseCode").html(xhr.status + " (Success)");
                                var timeResponse = new Date();
                                var timeString =
                                        ("0" + timeResponse.getHours()).slice(-2) + "h : " +
                                        ("0" + timeResponse.getMinutes()).slice(-2) + "m : " +
                                        ("0" + timeResponse.getSeconds()).slice(-2) + "s : " +
                                        ("0" + timeResponse.getMilliseconds()).slice(-2) + "ms";
                                $("#lastResponseEnd").html(timeString);
                                var timeDiff = Math.abs(timeResponse.getTime() - time.getTime());
                                var diffHours = timeDiff / (1000 * 3600);
                                console.log(diffHours);
                                $("#timeCost").html(((diffHours * 60 * 60 * 1000) + "").substr(0, 6));
                                db.transaction(function (tx) {
//                            tx.executeSql('INSERT INTO history (SUB_URL, METHOD, PARAMETERS, RESPONSE) VALUES ()');
                                    var href = location.href.split("/");
                                    href.pop();
                                    tx.executeSql(
                                            "INSERT INTO history (SUB_URL, METHOD, PARAMETERS, RESPONSE, STATUS_CODE, BASE_URL) VALUES (?,?,?,?,?,?)",
                                            [
                                                servletName,
                                                $("#requestMethod").prop("checked") ? "POST" : "GET",
                                                JSON.stringify($("#gapiRequest").parent().attr("class").includes("off") ? data : paramsWithValue),
                                                response,
                                                xhr.status,
                                                href.join("/") + "/"
                                            ]);
                                });
                                if ($("#autoRequest").parent().attr("class").includes("off")) {
                                    $("#btnDoRequest").click();
                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                $("#loader").hide();
                                $("#errorHtml").html(jqXHR.responseText);
                                $("body").addClass("default-background-color");
                                //                                console.log(errorThrown);
                                //                                console.log(JSON.stringify(jqXHR));
                                $("#lastResponseCode").html(jqXHR.status + " (" + errorThrown + ")");
                                var timeResponse = new Date();
                                var timeString =
                                        ("0" + timeResponse.getHours()).slice(-2) + "h : " +
                                        ("0" + timeResponse.getMinutes()).slice(-2) + "m : " +
                                        ("0" + timeResponse.getSeconds()).slice(-2) + "s : " +
                                        ("0" + timeResponse.getMilliseconds()).slice(-2) + "ms";
                                $("#lastResponseEnd").html(timeString);
                                $('#errorModal').modal('show');
                                var timeDiff = Math.abs(timeResponse.getTime() - time.getTime());
                                var diffHours = timeDiff / (1000 * 3600);
                                console.log(diffHours);
                                $("#timeCost").html(((diffHours * 60 * 60 * 1000) + "").substr(0, 6));
                                db.transaction(function (tx) {
                                    var href = location.href.split("/");
                                    href.pop();
                                    $("#urlText").html(href.join("/") + "/");
                                    tx.executeSql(
                                            "INSERT INTO history (SUB_URL, METHOD, PARAMETERS, RESPONSE, STATUS_CODE, BASE_URL) VALUES (?,?,?,?,?,?)",
                                            [
                                                servletName,
                                                $("#requestMethod").prop("checked") ? "POST" : "GET",
                                                JSON.stringify($("#gapiRequest").parent().attr("class").includes("off") ? data : paramsWithValue),
                                                jqXHR.responseText,
                                                jqXHR.status,
                                                href.join("/") + "/"
                                            ]);
                                });
                            }
                        };
                        if (data != {}) {
                            ajaxcallData["data"] = data;
                        }
                        //Ajax start functions
                        var time = new Date();
                        var timeString =
                                ("0" + time.getHours()).slice(-2) + "h : " +
                                ("0" + time.getMinutes()).slice(-2) + "m : " +
                                ("0" + time.getSeconds()).slice(-2) + "s : " +
                                ("0" + time.getMilliseconds()).slice(-2) + "ms";
                        $("#lastResponseStart").html(timeString); /**/
                        $("#errorHtml").html("");
                        $("#btnStatus").css("visibility", "visible");
                        $.ajax(ajaxcallData);
                    } else {
                        alert("Invalid data");
                    }
                } else {
                    alert("Servlet name Empty");
                }
            });
            $("#btnStatus").click(function () {
                $('#errorModal').modal('toggle');
            });
            //            $('#servletName').keypress(function (e) {
            //                if (!/[0-9a-zA-Z-]/.test(String.fromCharCode(e.which)))
            //                    return false;
            //            });
            $("#btnAddParam").click(function () {
                $("#paramDiv").append($('.eachRow').wrap('<div/>').parent().html());
                disableLastEachRow();
            });
            $("#btnClearParam,#btnClearAll").click(function () {
                clearAllParam();
            });
            $("#btnClearAll").click(function () {
                $("#servletName").val("");
                $("#btnClearResponse").click();
            });
            $("#btnClearResponse").click(function () {
                $("#response").val("");
                $("#errorHtml").html("");
            });
            $("#autoRequest").change(function () {
                if ($("#autoRequest").parent().attr("class").includes("off") && confirm("Press ESC button to Stop, Okay?")) {
                    $("#btnDoRequest").click();
                }
            });
            $("#gapiRequest").change(function () {
                if ($("#gapiRequest").parent().attr("class").includes("off")) {
                    $("#paramDiv").hide();
                    $("#gapiJSONContainer").show();
                } else {
                    $("#gapiJSONContainer").hide();
                    $("#paramDiv").show();
                }
            });
            $("#btnResponseInNewWindow").click(function () {
                var response;
                try {
                    response = "<pre>" + coloredJSONStringify(JSON.stringify(JSON.parse($("#response").val()), null, 4)) + "</pre>";
                } catch (e) {
                    console.log("Error converting response string to JSON; Error code " + e);
                    response = $("#response").val();
                }
                if (response.trim(" ") == "") {
                    alert("Reponse Empty");
                } else {
                    var win = window.open("", "Error", "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=" + screen.availWidth + ",height=" + screen.availHeight);
                    win.document.body.innerHTML = response;
                    win.document.title = localStorage.servletName.split("/").reverse()[0];
                }
            });
            $("#copyAjaxCode").click(function () {
                var data = {};
                var paramsWithValue = [];
                if ($("#gapiRequest").parent().attr("class").includes("off")) {
                    try {
                        data = JSON.stringify(JSON.parse($("#gapiJSON").val()));
                    } catch (e) {
                        console.log("Invalid JSON data for GApi Request; " + e.toString());
                    }
                } else if ($(".eachRow").length > 1) {
                    for (var i = 0; i < $(".eachRow").length - 1; i++) {
                        if ($($(".name-list")[i]).val() != ""
//                                    && $($(".value-list")[i]).val() != ""
                                ) {
                            try {
                                var json = JSON.parse($($(".value-list")[i]).val());
                                data[$($(".name-list")[i]).val()] = json;
                            } catch (e) {
                                data[$($(".name-list")[i]).val()] = $($(".value-list")[i]).val();
                            }
                            paramsWithValue.push({name: $($(".name-list")[i]).val(), value: $($(".value-list")[i]).val()});
                            if ($(".eachRow").length - 2 == i) {
                                complete = true;
                                break;
                            }
                        } else {
                            break;
                        }
                    }
                }
                var textHolder = document.getElementById("copyTextHolder");
                var copyText = "$.ajax({url: './" + localStorage.servletName + "',dataType: 'json',type: '" + ($("#requestMethod").prop("checked") ? "POST" : "GET") + "',data: " + JSON.stringify($("#gapiRequest").parent().attr("class").includes("off") ? data : paramsWithValue) + ",success: function (response, textStatus, xhr) {}});";
                textHolder.value = copyText;
                textHolder.select();
                document.execCommand("copy");
            });
            $("#historyShowBtn").click(function () {
                updateHistoryDatatable();
                $("#historyModal").modal("show");
            });
            $("#dumpWebSqlToHost").click(function () {
                $("#loader").show();
                websqldump.export({
                    database: 'ServiceCheckerUI',
                    success: function (sql) {
                        sql = sql.substring(0, 13) + "IF NOT EXISTS " + sql.substring(13); //Adding IF NOT EXISTS in Create Staement
                        var fileName = prompt("Enter file name", "WebSQLDump_" + (new Date().getTime()));
                        if (fileName == null) {
                            $("#loader").hide();
                            return;
                        }
                        var formData = new FormData();
                        formData.append("sql_file", new File([sql], fileName + ".sql", {type: "application/sql", lastModified: new Date()}));
                        $.ajax({
                            cache: false,
                            contentType: false,
                            processData: false,
                            type: 'POST',
                            url: "api/v1/generateRef?action=checker_development&checker_ui_action=backup_sql_dump",
                            data: formData,
                            success: function (json) {
                                if (json.request_status_code == 1) {
                                    alert("Dump file saved successfully !.");
                                    $("#webSQLModel").modal("hide");
                                } else if (json.request_status_code == 0) {
                                    alert(json.request_status_message);
                                }
                                $("#loader").hide();
                            }
                        });
                    }
                });
            });
            $("#dropDatabase").click(function () {
                var check = new Date().getTime();
                $("#loader").show();
                if (confirm("Are you sure ?") && prompt("Enter the below number :- \n" + check) == check) {
                    db.transaction(function (tx) {
                        tx.executeSql('DELETE FROM history');
                    });
                    alert("WebSQL Truncated");
                }
                $("#loader").hide();
            });
            $("#showHostDumpFiles").click(function () {
                $("#sqlSpinner").show();
                $.ajax({
                    url: "./api/v1/generateRef",
                    method: "POST",
                    data: {"checker_ui_action": "dump_file_list", "action": "checker_development"},
                    success: function (response, textStatus, xhr) {
                        $("#sqlSpinner").hide();
                        var innerHTML;
                        $("#dumpFileList tbody").html("");
                        response.files.forEach(function (val) {
                            innerHTML = "<tr>";
                            innerHTML += "<td>" + val.name + "</td><td>" + val.memory + "</td><td>" + new Date(val.upload_date).toString().substr(0, 24) + "</td><td><input type='button' class='btn btn-danger import' fileId='" + val.name + "' value='Import'></td>";
                            innerHTML += "</tr>";
                            $("#dumpFileList tbody").append(innerHTML);
                        });
                        $(".import").off("click");
                        $(".import").on("click", function () {
                            var fileId = $(this).attr("fileId");
                            $("#sqlSpinner").show();
                            $.ajax({
                                url: "./api/v1/generateRef",
                                method: "POST",
                                data: {"checker_ui_action": "get_dump_file", "action": "checker_development", "fileName": fileId},
                                success: function (response, textStatus, xhr) {
                                    if (response.request_status_code == 1) {
                                        db.transaction(function (tx) {
//                                            tx.executeSql(response.data);
                                            tx.executeSql(response.data, [], function () {}, function (tx, error) {
                                                console.log(error);
                                            });
                                        });
                                    } else {
                                        alert("Failed!. Something wrong!.");
                                    }
                                    $("#sqlSpinner").hide();
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    $("#sqlSpinner").hide();
                                }
                            });
                        });
                        $("#dumpFileList").parent().show();
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        $("#sqlSpinner").hide();
                    }
                });
            });
            var httpCodeData = {
                "100": "Continue",
                "101": "Switching Protocols",
                "200": "OK",
                "201": "Created",
                "202": "Accepted",
                "203": "Non-authoritative Information",
                "204": "No Content",
                "205": "Reset Content",
                "206": "Partial Content",
                "300": "Multiple Choices",
                "301": "Moved Permanently",
                "302": "Found",
                "303": "See Other",
                "304": "Not Modified",
                "305": "Use Proxy",
                "306": "Unused",
                "307": "Temporary Redirect",
                "400": "Bad Request",
                "401": "Unauthorized",
                "402": "Payment Required",
                "403": "Forbidden",
                "404": "Not Found",
                "405": "Method Not Allowed",
                "406": "Not Acceptable",
                "407": "Proxy Authentication Required",
                "408": "Request Timeout",
                "409": "Conflict",
                "410": "Gone",
                "411": "Length Required",
                "412": "Precondition Failed",
                "413": "Request Entity Too Large",
                "414": "Request-url Too Long",
                "415": "Unsupported Media Type",
                "416": "Requested Range Not Satisfiable",
                "417": "Expectation Failed",
                "500": "Internal Server Error",
                "501": "Not Implemented",
                "502": "Bad Gateway",
                "503": "Service Unavailable",
                "504": "Gateway Timeout",
                "505": "HTTP Version Not Supported"
            };
//                            "SELECT ID, SUB_URL, METHOD, SUBSTR(PARAMETERS,0,10) AS PARAMETERS_SUB, CASE WHEN STATUS_CODE = 200 THEN '' ELSE RESPONSE END AS RESPONSE, STATUS_CODE, REQUEST_TIME FROM history ORDER BY REQUEST_TIME DESC",
            function updateHistoryDatatable() {
                db.transaction(function (tx) {
                    var href = location.href.split("/");
                    href.pop();
                    $("#urlText").html(href.join("/") + "/");
                    tx.executeSql(
                            "SELECT ID, SUB_URL, METHOD, PARAMETERS, CASE WHEN STATUS_CODE = 200 THEN '<span style=\"color:blue\">{JSON}</span>' ELSE RESPONSE END AS RESPONSE, STATUS_CODE, REQUEST_TIME FROM history WHERE BASE_URL='" + href.join("/") + "/" + "' ORDER BY REQUEST_TIME DESC",
                            [],
                            function (tx, results) {
                                var dataSet = [];
                                var subURL = [], method = [], parameters = [], status_code = [];
                                for (var i = 0; i < results.rows.length; i++) {
                                    var eachRow = [];
                                    eachRow.push(results.rows[i].ID);
                                    eachRow.push(results.rows[i].SUB_URL);
                                    subURL.push(results.rows[i].SUB_URL);
                                    eachRow.push(results.rows[i].METHOD);
                                    method.push(results.rows[i].METHOD);
                                    var prams = JSON.parse(results.rows[i].PARAMETERS);
                                    if (results.rows[i].PARAMETERS.charAt(0) == "\"" && results.rows[i].PARAMETERS.charAt(1) == "{") {
//                                        parameters.push(coloredJSONStringify(JSON.stringify(prams)));
//                                        eachRow.push(coloredJSONStringify(prams));
                                        var params = "<pre>" + coloredJSONStringify(prams) + "</pre>";
//                                        if (params.length > 120)
//                                            params = "<span style='color:red'>JSON Too large</span>";
                                        eachRow.push(params);
                                    } else {
                                        var paramHTML = "";
                                        for (var j = 0; j < prams.length; j++) {
                                            paramHTML += "<span style='color:green'>" + prams[j].name + "</span> : <span style='color:blue'>" + prams[j].value + "</span><br>";
                                        }
//                                        parameters.push(paramHTML);
                                        eachRow.push(paramHTML);
                                    }
//                                    eachRow.push(results.rows[i].PARAMETERS_SUB);
                                    eachRow.push(results.rows[i].RESPONSE.replace(/(<([^>]+)>)/g, "").substr(0, 100));
                                    eachRow.push("<span style='color:" + (results.rows[i].STATUS_CODE == 200 ? "green" : "red") + "'>" + results.rows[i].STATUS_CODE + " - " + httpCodeData[results.rows[i].STATUS_CODE] + " </span>");
                                    status_code.push(results.rows[i].STATUS_CODE);
                                    eachRow.push(results.rows[i].REQUEST_TIME);
                                    eachRow.push((results.rows[i].PARAMETERS.charAt(0) == "\"" && results.rows[i].PARAMETERS.charAt(1) == "{") ? "GApi" : "Generic");
                                    eachRow.push("<input type='button' class='load btn btn-success' rowId='" + results.rows[i].ID + "' value='Load'>");
                                    dataSet.push(eachRow);
                                }
//                                subURL = removeDuplicates(subURL);
                                method = removeDuplicates(method);
//                                parameters = removeDuplicates(parameters);
                                status_code = removeDuplicates(status_code);
                                $('#historyDatatable tfoot th').each(function () {
                                    var title = $(this).text();
                                    var footerContext = this;
                                    if (title != "") {
                                        $(this).html('<input class="form-control datatable-search ' + title.replace(" ", "-") + '-search" type="text" placeholder="Search" />');
                                        $('.' + title.replace(" ", "-") + '-search').hide();
                                    }
                                    switch (title) {
//                                        case "Sub URL":
//                                            var innerHTML = "<select class='form-control'><option value='Clear'>Clear</option>";
//                                            subURL.forEach(function (value) {
//                                                innerHTML += "<option value='" + value.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\\\$&") + "'>" + value + "</option>";
//                                            });
//                                            $(footerContext).append(innerHTML + "</select>");
//                                            $(this).children("select").change(function () {
//                                                var val = $(this).val();
//                                                if ($(this).val() == "Clear") {
//                                                    $("." + title.replace(" ", "-") + "-search").val("").change();
//                                                } else {
//                                                    $("." + title.replace(" ", "-") + "-search").val(val).change();
//                                                }
//                                            });
//                                            break;
                                        case "Method":
                                            var innerHTML = "<select class='form-control'><option value='Clear'>Clear</option>";
                                            method.forEach(function (value) {
                                                innerHTML += "<option value='" + value + "'>" + value + "</option>";
                                            });
                                            $(footerContext).append(innerHTML + "</select>");
                                            $(this).children("select").change(function () {
                                                var val = $(this).val();
                                                if ($(this).val() == "Clear") {
                                                    $("." + title.replace(" ", "-") + "-search").val("").change();
                                                } else {
                                                    $("." + title.replace(" ", "-") + "-search").val(val).change();
                                                }
                                            });
                                            break;
//                                        case "Parameters":
//                                            var innerHTML = "<select>";
//                                            parameters.forEach(function (value) {
//                                                innerHTML += "<option value='" + value + "'>" + value.substr(0, 10) + "</option>";
//                                            });
//                                            $(footerContext).append(innerHTML + "</select>");
//                                            break;
                                        case "Status Code":
                                            var innerHTML = "<select class='form-control'><option value='Clear'>Clear</option>";
                                            status_code.forEach(function (value) {
                                                innerHTML += "<option value='" + value + "'>" + value + " - " + (value == 0 ? "Unknown" : httpCodeData[value]) + "</option>";
                                            });
                                            $(footerContext).append(innerHTML + "</select>");
                                            $(this).children("select").change(function () {
                                                var val = $(this).val();
                                                if ($(this).val() == "Clear") {
                                                    $("." + title.replace(" ", "-") + "-search").val("").change();
                                                } else {
                                                    $("." + title.replace(" ", "-") + "-search").val(val).change();
                                                }
                                            });
                                            break;
                                        default :
                                            $('.' + title.replace(" ", "-") + '-search').show();
                                            break;
                                    }
                                });
                                $('#historyDatatable').DataTable({
                                    data: dataSet,
//                                    columns: [
//                                        {title: "ID"},
//                                        {title: "Sub URL"},
//                                        {title: "Method"},
//                                        {title: "Parameters"},
//                                        {title: "Response"},
//                                        {title: "Status Code"},
//                                        {title: "Request Time"}
//                                    ],
                                    "columns": [
                                        {className: "col-xs-1 text-center"},
                                        {className: "col-xs-1 text-center"},
                                        {className: "col-xs-1 text-center"},
                                        {className: ""},
                                        {className: "col-xs-1 text-center"},
                                        {className: "col-xs-1 text-center"},
                                        {className: "col-xs-1 text-center"},
                                        {className: "col-xs-1 text-center"},
                                        {className: "col-xs-1 text-center"}
                                    ],
                                    initComplete: function () {
                                        $('#historyDatatable tbody').on('click', 'td .load', function () {
//                                        });
//                                        $(".load").click(function () {
                                            var rowId = $(this).attr("rowId");
                                            db.transaction(function (tx) {
                                                tx.executeSql(
                                                        "SELECT SUB_URL, METHOD, PARAMETERS FROM history WHERE ID='" + rowId + "' LIMIT 1",
                                                        [],
                                                        function (tx, results) {
                                                            localStorage.servletName = results.rows[0].SUB_URL;
                                                            localStorage.data = results.rows[0].PARAMETERS;
                                                            localStorage.requestMethod = results.rows[0].METHOD;
                                                            window.location.reload();
                                                        });
                                            });
                                        });
                                        if ($("#historyDatatable tbody tr").size() - $(".dataTables_empty").size() <= 0)
                                            $(".footer-datatable").hide();
                                        else
                                            $(".footer-datatable").show();
                                        this.api().columns().every(function () {
                                            // Apply the search
                                            this.every(function () {
                                                var that = this;
                                                $('input', this.footer()).on('keyup change', function () {
                                                    if (that.search() !== this.value) {
                                                        that
                                                                .search(this.value)
                                                                .draw();
                                                    }
                                                });
                                            });
                                        });
                                    },
                                    destroy: true,
                                    "order": [[6, 'desc']], "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]]
                                });
                            }
                    );
                });
            }
            function disableLastEachRow() {
                $($(".eachRow")[$(".eachRow").length - 1]).hide();
                for (var i = 0; i < $(".eachRow").length - 1; i++) {
                    $($(".eachRow")[i]).show();
                }
            }
            function clearAllParam() {
                var eachParamRow = $('.eachRow').wrap('<div/>').parent().html();
                $('#paramDiv').html("");
                $("#paramDiv").append(eachParamRow);
                disableLastEachRow();
            }
            function syntaxHighlight(json) {
                if (typeof json != 'string') {
                    json = JSON.stringify(json, undefined, 2);
                }
                json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    var cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                        } else {
                            cls = 'string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            }
            function coloredJSONStringify(json) {
                json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return (json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    var cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                        } else {
                            cls = 'string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                })) + "<style>pre {padding: 5px; margin: 5px; width: fit-content;}.string { color: green; }.number { color: darkorange; }.boolean { color: blue; }.null { color: magenta; }.key { color: red; }</style>";
            }
            function removeDuplicates(arr) {
                let unique_array = [];
                for (let i = 0; i < arr.length; i++) {
                    if (unique_array.indexOf(arr[i]) == -1) {
                        unique_array.push(arr[i]);
                    }
                }
                return unique_array;
            }
        </script>
    </body>
</html>























